!function(t){var e={};function s(i){if(e[i])return e[i].exports;var r=e[i]={i:i,l:!1,exports:{}};return t[i].call(r.exports,r,r.exports,s),r.l=!0,r.exports}s.m=t,s.c=e,s.d=function(t,e,i){s.o(t,e)||Object.defineProperty(t,e,{configurable:!1,enumerable:!0,get:i})},s.r=function(t){Object.defineProperty(t,"__esModule",{value:!0})},s.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return s.d(e,"a",e),e},s.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},s.p="",s(s.s=0)}([function(t,e,s){"use strict";s.r(e);class i{constructor(t,e){this.source=t,this.rules=e,this.position=0}peek(){return this.peeked=this.scan()}match(t,e){let s=this.peek();return!(!s||s.type!=t||e&&s.raw!=e)&&(this.peeked=null,!0)}scan(){if(this.peeked){let t=this.peeked;return this.peeked=null,t}var t=null,e=0;if(this.rules.forEach(s=>{s.r.lastIndex=this.position;var i=s.r.exec(this.source);i&&i[0].length>e&&this.position+i[0].length==s.r.lastIndex&&((t=s.fn(this,i)).offset=this.position,t.raw=i[0],e=i[0].length)}),this.position+=e,null==t){if(this.position==this.source.length)return null;throw new Error("Unexpected character at "+this.position+": "+JSON.stringify(this.source))}return t}}let r=new class{constructor(){this.rules=[]}terminal(t,e){this.rules.push({r:new RegExp(t,"g"),fn:e})}lex(t){return new i(t,this.rules)}};r.terminal("[\\s,]+",(t,e)=>({type:"ws"})),r.terminal(";.*",(t,e)=>({type:"comment"})),r.terminal("\\(|\\[|\\{|#\\(|#?\\(|#\\{|#?@\\(",(t,e)=>({type:"open"})),r.terminal("\\)|\\]|\\}",(t,e)=>({type:"close"})),r.terminal("~@|~|'|#'|#:|#_|\\^|`|#|\\^:",(t,e)=>({type:"punc"})),r.terminal("true|false|nil",(t,e)=>({type:"lit"})),r.terminal("[0-9]+[rR][0-9a-zA-Z]+",(t,e)=>({type:"lit"})),r.terminal("[-+]?[0-9]+(\\.[0-9]+)?([eE][-+]?[0-9]+)?",(t,e)=>({type:"lit"})),r.terminal(":[^()[\\]\\{\\}#,~@'`^\"\\s]*",(t,e)=>({type:"kw"})),r.terminal("[^()[\\]\\{\\}#,~@'`^\"\\s:][^()[\\]\\{\\}#,~@'`^\"\\s]*",(t,e)=>({type:"id"})),r.terminal('"([^"\\\\]|\\\\.)*"?',(t,e)=>({type:"str"})),r.terminal(".",(t,e)=>({type:"junk"}));let n=document.createElement("canvas").getContext("2d");function l(t){return n.measureText(t).width}let h=new Set(["if","let","do","while","cond","case"]);function o(t){let e=document.createElement("span"),s=t.type;return"id"==t.type&&(t.raw.startsWith("def")?s="decl":h.has(t.raw)&&(s="macro")),e.textContent=t.raw,e.className=s,e}class a{constructor(t){this.text=t,this.tokens=[]}}class d{constructor(){this.lines=[new a("")],this.changedLines=new Set,this.insertedLines=new Set,this.deletedLines=new Set}getOffsetForLine(t){let e=0;for(let s=0;s<t;s++)e+=this.lines[s].text.length+1;return e}getRowCol(t){for(let e=0;e<this.lines.length;e++){if(!(t>this.lines[e].text.length))return[e,t];t-=this.lines[e].text.length+1}return[this.lines.length-1,this.lines[this.lines.length-1].text.length]}insertString(t,e){let[s,i]=this.getRowCol(t),r=e.split(/\r\n|\n/),n=0;if(1==r.length)this.lines[s].text=this.lines[s].text.substring(0,i)+e+this.lines[s].text.substring(i),n+=e.length;else{let t=this.lines[s].text.substring(i);this.lines[s].text=this.lines[s].text.substring(0,i)+r[0];let e=[];for(let t=1;t<r.length-1;t++)e.push(new a(r[t]));e.push(new a(r[r.length-1]+t));for(let t=0;t<r.length;t++)n+=r[t].length;this.insertedLines.add([s,r.length-1]),this.lines.splice(s+1,0,...e),n++}for(let t=0;t<r.length;t++)this.changedLines.add(s+t);return n}deleteRange(t,e){let[s,i]=e>0?this.getRowCol(t):this.getRowCol(t+e),[r,n]=e>0?this.getRowCol(t+e):this.getRowCol(t);if(r!=s){let t=this.lines[s].text.substring(0,i),e=this.lines[r].text.substring(n);this.lines[s].text=t+e,this.lines.splice(s+1,r-s),this.changedLines.add(s),this.deletedLines.add([s+1,r-s])}else this.lines[s].text=this.lines[s].text.substring(0,i)+this.lines[s].text.substring(i+e),this.changedLines.add(s)}get maxOffset(){let t=0;for(let e=0;e<this.lines.length;e++)t+=this.lines[e].text.length+1;return t-1}}window.addEventListener("keydown",t=>{if(1==t.key.length)c.insertString(t.key);else switch(t.keyCode){case 9:t.preventDefault();break;case 13:c.insertString("\n");break;case 37:c.caretLeft(!t.shiftKey);break;case 39:c.caretRight(!t.shiftKey);break;case 8:c.backspace();break;case 36:t.ctrlKey?c.caretHomeAll(!t.shiftKey):c.caretHome(!t.shiftKey);break;case 35:t.ctrlKey?c.caretEndAll(!t.shiftKey):c.caretEnd(!t.shiftKey);break;case 38:c.caretUp(!t.shiftKey);break;case 40:c.caretDown(!t.shiftKey);break;case 46:c.delete()}});let c=new class{constructor(t){this.mainElem=t,this._cursorStart=0,this._cursorEnd=0,this.lastCursorStart=0,this.lastCursorEnd=0,this.model=new d,this.inputLines=[],this.caretX=0,this.mainElem.addEventListener("mousedown",t=>{this.cursorEnd=this.positionToOffset(t.pageX,t.pageY),this.caretX=this.model.getRowCol(this.cursorEnd)[1],this.updateState()}),this.caret=document.createElement("div"),this.caret.className="caret";let e=this.makeLine();this.inputLines.push(e),this.mainElem.appendChild(e),n.font=getComputedStyle(e).font+"",this.caret.style.width=l("M")+"px",e.appendChild(this.caret)}get cursorStart(){return this._cursorStart}set cursorStart(t){this._cursorStart=Math.min(this.model.maxOffset,Math.max(t,0))}get cursorEnd(){return this._cursorEnd}set cursorEnd(t){this._cursorEnd=Math.min(this.model.maxOffset,Math.max(t,0))}insertString(t){this.cursorEnd+=this.model.insertString(this.cursorEnd,t),this.cursorStart=this.cursorEnd,this.updateState(),this.caretX=this.model.getRowCol(this.cursorEnd)[1]}caretLeft(t=!0){this.cursorEnd--,t&&(this.cursorStart=this.cursorEnd),this.updateState(),this.caretX=this.model.getRowCol(this.cursorEnd)[1]}caretRight(t=!0){this.cursorEnd++,t&&(this.cursorStart=this.cursorEnd),this.updateState(),this.caretX=this.model.getRowCol(this.cursorEnd)[1]}caretHomeAll(t=!0){this.cursorEnd=0,t&&(this.cursorStart=this.cursorEnd),this.updateState(),this.caretX=this.model.getRowCol(this.cursorEnd)[1]}caretEndAll(t=!0){this.cursorEnd=this.model.maxOffset,t&&(this.cursorStart=this.cursorEnd),this.updateState(),this.caretX=this.model.getRowCol(this.cursorEnd)[1]}caretHome(t=!0){let[e,s]=this.model.getRowCol(this.cursorEnd);this.cursorEnd=this.cursorEnd-s,t&&(this.cursorStart=this.cursorEnd),this.updateState(),this.caretX=this.model.getRowCol(this.cursorEnd)[1]}caretEnd(t=!0){let[e,s]=this.model.getRowCol(this.cursorEnd);this.cursorEnd=this.cursorEnd-s+this.model.lines[e].text.length,t&&(this.cursorStart=this.cursorEnd),this.updateState()}caretUp(t=!0){let[e,s]=this.model.getRowCol(this.cursorEnd);if(e>0){let t=this.model.lines[e-1].text.length;this.cursorEnd=this.model.getOffsetForLine(e-1)+Math.min(this.caretX,t)}else this.cursorEnd=0;t&&(this.cursorStart=this.cursorEnd),this.updateState()}caretDown(t=!0){let[e,s]=this.model.getRowCol(this.cursorEnd);if(e<this.model.lines.length-1){let t=this.model.lines[e+1].text.length;this.cursorEnd=this.model.getOffsetForLine(e+1)+Math.min(this.caretX,t)}else this.cursorEnd=this.model.maxOffset;t&&(this.cursorStart=this.cursorEnd),this.updateState()}backspace(){this.cursorEnd>0&&(this.model.deleteRange(this.cursorEnd-1,1),this.cursorEnd--),this.updateState(),this.caretX=this.model.getRowCol(this.cursorEnd)[1]}delete(){this.model.deleteRange(this.cursorEnd,1),this.updateState(),this.caretX=this.model.getRowCol(this.cursorEnd)[1]}makeSelection(t,e){let s=document.createElement("div");s.className="sel-marker";let i=t;return s.style.left=i+"px",s.style.width=e+"px",s}updateState(){for(let[t,e]of this.model.insertedLines)for(let s=0;s<e;s++){let e=this.makeLine();this.inputLines[t+s+1]?this.mainElem.insertBefore(e,this.inputLines[t+s+1]):this.mainElem.append(e),this.inputLines.splice(t+s+1,0,e)}this.model.insertedLines.clear();for(let[t,e]of this.model.deletedLines){for(let s=0;s<e;s++)this.mainElem.removeChild(this.inputLines[t+s]);this.inputLines.splice(t,e)}this.model.deletedLines.clear();for(let t of this.model.changedLines){let e=this.inputLines[t].querySelector(".content");for(;e.firstChild;)e.removeChild(e.firstChild);let s=r.lex(this.model.lines[t].text);for(;;){let t=s.scan();if(!t)break;e.appendChild(o(t))}e.firstChild||e.appendChild(document.createTextNode(" "))}this.model.changedLines.clear();let[t,e]=this.model.getRowCol(this.cursorEnd);this.inputLines[t].appendChild(this.caret),this.caret.style.left=l(this.model.lines[t].text.substr(0,e))+"px";let s=this.model.getRowCol(Math.min(this.lastCursorStart,this.lastCursorEnd,this.cursorStart,this.cursorEnd)),i=this.model.getRowCol(Math.max(this.lastCursorStart,this.lastCursorEnd,this.cursorStart,this.cursorEnd)),n=this.model.getRowCol(Math.min(this.cursorStart,this.cursorEnd)),h=this.model.getRowCol(Math.max(this.cursorStart,this.cursorEnd));for(let t=s[0];t<=i[0];t++){let e=this.inputLines[t].querySelector(".selection");if(t<n[0]||t>h[0])for(;e.firstChild;)e.removeChild(e.firstChild);else if(t==n[0]&&t==h[0]){for(;e.firstChild;)e.removeChild(e.firstChild);let t=l("M")*n[1];e.appendChild(this.makeSelection(t,l("M")*h[1]-t))}else if(t==n[0]){for(;e.firstChild;)e.removeChild(e.firstChild);let s=l("M")*n[1];e.appendChild(this.makeSelection(s,l("M")*this.model.lines[t].text.length-s))}else if(t==h[0]){for(;e.firstChild;)e.removeChild(e.firstChild);e.appendChild(this.makeSelection(0,l("M")*h[1]))}else if(t>n[0]&&t<h[0]){for(;e.firstChild;)e.removeChild(e.firstChild);e.appendChild(this.makeSelection(0,Math.max(l("M"),l("M")*this.model.lines[t].text.length)))}}this.lastCursorStart=this.cursorStart,this.lastCursorEnd=this.cursorEnd}positionToOffset(t,e){let s,i=this.mainElem.getBoundingClientRect(),r=e-i.top;for(s=0;s<this.mainElem.children.length&&!(r<this.mainElem.children.item(s).offsetTop);s++);s--;let n=this.model.getOffsetForLine(s);return n+=Math.min(Math.floor((t-i.left)/l("M")),this.model.lines[s].text.length)}makeLine(){let t=document.createElement("div");t.className="line";let e=document.createElement("div");e.className="content",t.append(e);let s=document.createElement("div");return s.className="selection",t.append(s),t}}(document.getElementById("repl"))}]);